<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="../fotoSob.jpg">
	<link rel="stylesheet" href="../style.css">
	<script src="../script.js" defer></script>
	<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
	<title>google classic site template</title>
	</head>
	<body>
		november 12, 22:55
	<header id="header">
		<div id="back1">
		<div class="grad">
			<a href="../">hellocccd&gt;&gt;67</a>
		</div>
		</div>
	</header>
	<nav>
		<a href="#footer"><button>bottom</button></a>
		<a href="#header"><button id="btop">top</button></a>
		<a href="https://github.com/Zaydiscool777/zaydiscool777.github.io" style="all:initial;">
		<button>View the source!</button>
		</a>
	</nav>
	
	<article>
		<p>
			You can compute floor division of a number by multiplying, especially by its modular inverse.
			This article is on how to use this trick to do division faster than <samp>idiv</samp>,
			using the Granlund-Montgomery algorithm.
		</p>
		<div class="latex">
			For
				$$q = \lfloor \frac{n}{d} \rfloor,$$
			we can instead use
				$$q = nM \gg s.$$
			By first thinking about it as
				$$q = \lfloor \frac{n}{d} \rfloor = \lfloor \frac{nM}{2^{p}} \rfloor,$$
			This makes
				$$\lfloor \frac{1}{d} \rfloor = \lfloor \frac{M}{2^{p}} \rfloor,$$
			and, in fact,
				$$M \approx \lceil \frac{2^{p}}{d} \rceil.$$
			We can then make
				$$p = b + s,$$
			where b is the size of the inputs of multipication.
			For example, on 64-bit hardware, b = 64, but for C's integers, b = 32.
			We can now solve for M using
				$$M = \lceil \frac{2^{64 + s}}{d} \rceil,$$
			using the smallest non-zero natural for s, so the formula works for all n.
			Finding s is usually done on an incremental basis.
			Checking s can usually be done by applying many inputs and checking them all, but there is a systematic
			way of checking s.
			With
				$$0 \le r = n - qd \le d - 1,$$
			r is the remainder, so
				$$n = qd + r.$$
			Then,
				$$nM = qdM + rM.$$
			Now, change
				$$dM \to 2^{p} - e,$$
			(defining e) and then, using the distributive property and associativity property,
				$$nM = q2^{p} + (qe + rM).$$
			If we floor divide by 2^p, and then subtract q on both sides, we get
				$$\lfloor \frac{nM}{2^{p}} \rfloor - q = \lfloor \frac{qe + rM}{2^{p}} \rfloor.$$
			(q is not floored, since it is an integer.)
			Since we defined q as the minuend they are both the same.
			Thus, on the right-hand side, if s and M really are correct, should be $0$.
			With the largest quotient
				$$0 \le q \le Q = \frac{2^{b} - 1}{d},$$
			We can substitute the maxima to get this inequality for checking s and M:
				$$Qe + (d - 1)M \le 2^{p} - 1.$$
		</div>
		<p>
			If I put 10 for d and 64 for b, I get
			M = <samp>0xCCCCCCCCCCCCCCCD</samp> and s = 3.
			This is quite useful for printing numbers without a standard librar,
			as it is around 4 times faster than normal division.
			You can also use the Extended Euclidean algorithm to get
			1/5 mod 2<sup>64</sup>, but that is an exercise for the
			reader.
		</p>
		<p>
			I have to thank ChatGPT for finding most of this,
			But more importantly Torbjoern Granlund and Peter L. Montgomery
			for <a href="https://gmplib.org/~tege/divcnst-pldi94.pdf">this paper</a>
			on what I talked about, called "Division by Invariant Integers using Multiplication".
		</p>
		<code>
			mov r8, rax ; for remainder
			mov rdx, 0xCCCC_CCCC_CCCC_CCCD ; 1/5
			mul rdx
			mov rbx, rdx ; for remainder
			shr rbx, 3

			vs.

			mov rax, r8
			mov rdx, rbx
			shl rdx, 3
			lea rdx, [rdx + rbx * 2]
			sub rax, rdx
			mov rdx, rbx
			xchg rax, rdx
		</code>
	</article>

	<br><br><br>
	<hr id="footer">
	
	<!--disqus-->
	
	<disqus>
		<div id="disqus_thread"></div>
		<!--Append #disqus_thread to the href attribute in your links. This will tell Disqus which links to look up and return the comment count. For example: <a href="http://foo.com/bar.html#disqus_thread">Link</a>.-->
		<script>
		/**
		 *	RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		 *	LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables		*/

		var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = "apricot-glimmer-chokeberry-glitch-me"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		};

		(function () {
			// DON'T EDIT BELOW THIS LINE
			var d = document,
			s = d.createElement("script");
			s.src =
			"https://apricot-glimmer-chokeberry-glitch-me.disqus.com/embed.js";
			s.setAttribute("data-timestamp", +new Date());
			(d.head || d.body).appendChild(s);
		})();
		</script>
		<noscript>
		Please enable JavaScript to view the
		<a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
		</noscript>
		<script
		id="dsq-count-scr"
		src="//apricot-glimmer-chokeberry-glitch-me.disqus.com/count.js"
		async></script>
		<!--edit src?-->
	</disqus>
	</body>
</html>
